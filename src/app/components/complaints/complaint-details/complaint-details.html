<div class="complaint-details-container">
    <!-- Page Header -->
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <h2 class="h3 mb-0 text-gradient">Complaint Details</h2>
            <p class="text-muted mb-0">View and manage individual complaint</p>
        </div>
        <div class="d-flex gap-2">
            <button class="btn btn-outline-secondary" (click)="goBack()">
                <i class="fas fa-arrow-left me-2"></i>Back to List
            </button>
            <button class="btn btn-primary" (click)="refreshData()">
                <i class="fas fa-sync me-2"></i>Refresh
            </button>
        </div>
    </div>

    <!-- Loading State -->
    <div *ngIf="isLoading" class="text-center py-5">
        <div class="spinner-border text-primary" role="status">
            <span class="visually-hidden">Loading...</span>
        </div>
        <p class="mt-3 text-muted">Loading complaint details...</p>
    </div>

    <!-- Error State -->
    <div *ngIf="error" class="alert alert-danger">
        <i class="fas fa-exclamation-triangle me-2"></i>{{ error }}
        <button class="btn btn-sm btn-outline-danger ms-2" (click)="loadComplaintDetails()">
            Try Again
        </button>
    </div>

    <!-- Complaint Details Content -->
    <div *ngIf="!isLoading && !error && complaint">
        <div class="row g-4">
            <!-- Left Column - Complaint Information -->
            <div class="col-lg-8">
                <!-- Basic Information Card -->
                <div class="card mb-4">
                    <div class="card-header">
                        <h5 class="card-title mb-0">
                            <i class="fas fa-info-circle me-2"></i>Complaint Information
                        </h5>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-6">
                                <div class="info-item mb-3">
                                    <label class="info-label">Complaint ID</label>
                                    <div class="info-value">
                                        <code>{{ complaint.id }}</code>
                                    </div>
                                </div>

                                <div class="info-item mb-3">
                                    <label class="info-label">Title</label>
                                    <div class="info-value fw-bold">{{ complaint.title }}</div>
                                </div>

                                <div class="info-item mb-3">
                                    <label class="info-label">Category</label>
                                    <div class="info-value">
                                        <span class="badge bg-light text-dark">{{ complaint.category }}</span>
                                    </div>
                                </div>

                                <div class="info-item mb-3">
                                    <label class="info-label">Priority</label>
                                    <div class="info-value">
                                        <span [class]="getPriorityBadgeClass(complaint.priority)">
                                            {{ complaint.priority }}
                                        </span>
                                    </div>
                                </div>
                            </div>

                            <div class="col-md-6">
                                <div class="info-item mb-3">
                                    <label class="info-label">Status</label>
                                    <div class="info-value">
                                        <span [class]="getStatusBadgeClass(complaint.status)">
                                            {{ complaint.status }}
                                        </span>
                                    </div>
                                </div>

                                <div class="info-item mb-3">
                                    <label class="info-label">Submission Date</label>
                                    <div class="info-value">
                                        {{ formatDate(complaint.submissionDate) }}
                                        <small class="text-muted d-block">
                                            {{ getDaysSinceSubmission(complaint.submissionDate) }} days ago
                                        </small>
                                    </div>
                                </div>

                                <!-- ❌ REMOVED: Assigned To section -->

                                <div class="info-item mb-3" *ngIf="complaint.resolutionDate">
                                    <label class="info-label">Resolution Date</label>
                                    <div class="info-value">
                                        {{ formatDate(complaint.resolutionDate) }}
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Member Information Card -->
                <div class="card mb-4">
                    <div class="card-header">
                        <h5 class="card-title mb-0">
                            <i class="fas fa-user me-2"></i>Member Information
                        </h5>
                    </div>
                    <div class="card-body">
                        <div class="row align-items-center">
                            <div class="col-md-8">
                                <div class="member-info">
                                    <h6 class="fw-bold mb-1">{{ complaint.memberName }}</h6>
                                    <p class="text-muted mb-2">Member ID: {{ complaint.memberId }}</p>
                                    <div class="contact-preference">
                                        <i [class]="getContactPreferenceIcon(complaint.contactPreference)" class="me-1"></i>
                                        Preferred Contact: {{ complaint.contactPreference }}
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-4 text-end">
                                <button class="btn btn-outline-info" (click)="viewMemberDetails()">
                                    <i class="fas fa-eye me-2"></i>View Profile
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Description Card -->
                <div class="card mb-4">
                    <div class="card-header">
                        <h5 class="card-title mb-0">
                            <i class="fas fa-file-alt me-2"></i>Complaint Description
                        </h5>
                    </div>
                    <div class="card-body">
                        <div class="complaint-description">
                            {{ complaint.description }}
                        </div>
                    </div>
                </div>

                <!-- Resolution Notes (if resolved) -->
                <div class="card mb-4" *ngIf="complaint.resolutionNotes">
                    <div class="card-header">
                        <h5 class="card-title mb-0">
                            <i class="fas fa-check-circle me-2"></i>Resolution Notes
                        </h5>
                    </div>
                    <div class="card-body">
                        <div class="resolution-notes">
                            {{ complaint.resolutionNotes }}
                        </div>
                    </div>
                </div>

                <!-- Responses Timeline -->
                <div class="card">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <h5 class="card-title mb-0">
                            <i class="fas fa-comments me-2"></i>Response Timeline
                        </h5>
                        <button class="btn btn-sm btn-primary" (click)="openResponseModal()" *ngIf="!isResolved()">
                            <i class="fas fa-plus me-2"></i>Add Response
                        </button>
                    </div>
                    <div class="card-body">
                        <div *ngIf="complaint.responses && complaint.responses.length > 0; else noResponses">
                            <div class="timeline">
                                <div *ngFor="let response of complaint.responses; let i = index" class="timeline-item">
                                    <div class="timeline-marker" [class.admin-marker]="response.isFromAdmin">
                                        <i class="fas" [class.fa-user-shield]="response.isFromAdmin" [class.fa-user]="!response.isFromAdmin"></i>
                                    </div>
                                    <div class="timeline-content">
                                        <div class="timeline-header">
                                            <span class="fw-bold">{{ response.respondedBy }}</span>
                                            <span class="badge ms-2" [class.bg-primary]="response.isFromAdmin" [class.bg-secondary]="!response.isFromAdmin">
                                                {{ response.isFromAdmin ? 'Admin' : 'Member' }}
                                            </span>
                                            <small class="text-muted ms-auto">{{ formatDate(response.responseDate) }}</small>
                                        </div>
                                        <div class="timeline-body">
                                            {{ response.responseText }}
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <ng-template #noResponses>
                            <div class="text-center py-4">
                                <i class="fas fa-comments fa-2x text-muted mb-3"></i>
                                <p class="text-muted">No responses yet</p>
                                <button class="btn btn-outline-primary" (click)="openResponseModal()" *ngIf="!isResolved()">
                                    <i class="fas fa-plus me-2"></i>Add First Response
                                </button>
                            </div>
                        </ng-template>
                    </div>
                </div>
            </div>

            <!-- Right Column - Actions -->
            <div class="col-lg-4">
                <!-- Quick Actions Card -->
                <div class="card mb-4">
                    <div class="card-header">
                        <h5 class="card-title mb-0">
                            <i class="fas fa-cogs me-2"></i>Quick Actions
                        </h5>
                    </div>
                    <div class="card-body">
                        <div class="d-grid gap-2">
                            <!-- ❌ REMOVED: Assignment button -->

                            <button class="btn btn-outline-info" (click)="openStatusModal()">
                                <i class="fas fa-edit me-2"></i>Update Status
                            </button>

                            <button class="btn btn-outline-success" (click)="openResponseModal()" *ngIf="!isResolved()">
                                <i class="fas fa-reply me-2"></i>Add Response
                            </button>

                            <button class="btn btn-outline-secondary" (click)="viewMemberDetails()">
                                <i class="fas fa-user me-2"></i>View Member
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Complaint Stats Card -->
                <div class="card">
                    <div class="card-header">
                        <h5 class="card-title mb-0">
                            <i class="fas fa-chart-bar me-2"></i>Complaint Stats
                        </h5>
                    </div>
                    <div class="card-body">
                        <div class="stat-item">
                            <div class="stat-label">Days Since Submission</div>
                            <div class="stat-value">{{ getDaysSinceSubmission(complaint.submissionDate) }}</div>
                        </div>

                        <div class="stat-item">
                            <div class="stat-label">Total Responses</div>
                            <div class="stat-value">{{ getTotalResponses() }}</div>
                        </div>

                        <div class="stat-item">
                            <div class="stat-label">Admin Responses</div>
                            <div class="stat-value">{{ getAdminResponsesCount() }}</div>
                        </div>

                        <div class="stat-item" *ngIf="complaint.resolutionDate">
                            <div class="stat-label">Resolution Time</div>
                            <div class="stat-value">{{ getResolutionTimeDays() }} days</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Response Modal -->
<div class="modal fade" [class.show]="showResponseModal" [style.display]="showResponseModal ? 'block' : 'none'" *ngIf="showResponseModal">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="fas fa-reply me-2"></i>Add Response
                </h5>
                <button type="button" class="btn-close" (click)="closeResponseModal()"></button>
            </div>
            <form [formGroup]="responseForm" (ngSubmit)="submitResponse()">
                <div class="modal-body">
                    <div class="mb-3">
                        <label for="responseText" class="form-label">Response Message <span class="text-danger">*</span></label>
                        <textarea
                            id="responseText"
                            class="form-control"
                            rows="6"
                            placeholder="Enter your response message..."
                            formControlName="responseText"
                            [class.is-invalid]="responseText?.invalid && responseText?.touched"
                        ></textarea>
                        <div class="invalid-feedback" *ngIf="responseText?.invalid && responseText?.touched">
                            <div *ngIf="responseText?.errors?.['required']">Response message is required</div>
                            <div *ngIf="responseText?.errors?.['minlength']">Response must be at least 10 characters long</div>
                            <div *ngIf="responseText?.errors?.['maxlength']">Response must not exceed 1000 characters</div>
                        </div>
                        <div class="form-text">
                            {{ responseText?.value?.length || 0 }}/1000 characters
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" (click)="closeResponseModal()">Cancel</button>
                    <button type="submit" class="btn btn-primary" [disabled]="responseForm.invalid || isSubmittingResponse">
                        <span *ngIf="isSubmittingResponse" class="spinner-border spinner-border-sm me-2"></span>
                        <i *ngIf="!isSubmittingResponse" class="fas fa-reply me-2"></i>
                        {{ isSubmittingResponse ? 'Adding...' : 'Add Response' }}
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- ❌ REMOVED: Assignment Modal -->

<!-- Status Update Modal -->
<app-confirmation-dialog
    [isVisible]="showStatusModal"
    [title]="'Update Status'"
    [message]="'Select new status for this complaint:'"
    [confirmText]="'Update Status'"
    [cancelText]="'Cancel'"
    [isProcessing]="isUpdatingStatus"
    (confirmed)="updateStatus()"
    (cancelled)="closeStatusModal()">

    <div class="mt-3">
        <select class="form-select" [(ngModel)]="selectedStatus" required>
            <option value="">Select Status</option>
            <option *ngFor="let status of statusOptions" [value]="status">
                {{ status }}
            </option>
        </select>
    </div>
</app-confirmation-dialog>

<!-- Modal Backdrop -->
<div class="modal-backdrop fade show" *ngIf="showResponseModal" (click)="closeResponseModal()"></div>
