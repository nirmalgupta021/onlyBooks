<div class="complaint-dashboard-container">
  <!-- Page Header -->
  <div class="d-flex justify-content-between align-items-center mb-4">
    <div>
      <h2 class="h3 mb-0 text-gradient">Complaint Management</h2>
      <p class="text-muted mb-0">Manage all customer complaints and support requests</p>
    </div>
    <div class="d-flex gap-2">
      <button class="btn btn-outline-primary" (click)="navigateToManagement()">
        <i class="fas fa-chart-bar me-2"></i>Analytics
      </button>
      <button class="btn btn-primary" (click)="refreshData()">
        <i class="fas fa-sync me-2"></i>Refresh
      </button>
    </div>
  </div>

  <!-- Statistics Cards -->
  <div class="row g-4 mb-4">
    <div class="col-xl-3 col-lg-6 col-md-6">
      <div class="stat-card bg-primary">
        <div class="stat-icon">
          <i class="fas fa-comments"></i>
        </div>
        <div class="stat-content">
          <h3>{{ totalComplaints }}</h3>
          <p>Total Complaints</p>
        </div>
      </div>
    </div>

    <div class="col-xl-3 col-lg-6 col-md-6">
      <div class="stat-card bg-warning">
        <div class="stat-icon">
          <i class="fas fa-clock"></i>
        </div>
        <div class="stat-content">
          <h3>{{ pendingComplaints }}</h3>
          <p>Pending Review</p>
        </div>
      </div>
    </div>

    <div class="col-xl-3 col-lg-6 col-md-6">
      <div class="stat-card bg-info">
        <div class="stat-icon">
          <i class="fas fa-cog"></i>
        </div>
        <div class="stat-content">
          <h3>{{ inProgressComplaints }}</h3>
          <p>In Progress</p>
        </div>
      </div>
    </div>

    <div class="col-xl-3 col-lg-6 col-md-6">
      <div class="stat-card bg-success">
        <div class="stat-icon">
          <i class="fas fa-check-circle"></i>
        </div>
        <div class="stat-content">
          <h3>{{ resolvedComplaints }}</h3>
          <p>Resolved</p>
        </div>
      </div>
    </div>
  </div>

  <!-- Search and Filter Card -->
  <div class="card mb-4">
    <div class="card-header">
      <h5 class="card-title mb-0">
        <i class="fas fa-filter me-2"></i>Search and Filter Complaints
      </h5>
    </div>
    <div class="card-body">
      <div class="row g-3">
        <!-- Search Input -->
        <div class="col-md-3">
          <label class="form-label">Search</label>
          <div class="input-group">
            <span class="input-group-text">
              <i class="fas fa-search"></i>
            </span>
            <input
              type="text"
              class="form-control"
              placeholder="Search by ID, Member, Title..."
              [(ngModel)]="searchTerm"
            />
          </div>
        </div>

        <!-- Date Range Filters -->
        <div class="col-md-2">
          <label class="form-label">From Date</label>
          <input
            type="date"
            class="form-control"
            [(ngModel)]="selectedDateFrom"
          />
        </div>
        <div class="col-md-2">
          <label class="form-label">To Date</label>
          <input
            type="date"
            class="form-control"
            [(ngModel)]="selectedDateTo"
          />
        </div>

        <!-- Category Filter -->
        <div class="col-md-2">
          <label class="form-label">Category</label>
          <select class="form-select" [(ngModel)]="selectedCategory">
            <option value="">All Categories</option>
            <option *ngFor="let category of categories" [value]="category">
              {{ category }}
            </option>
          </select>
        </div>

        <!-- Status Filter -->
        <div class="col-md-2">
          <label class="form-label">Status</label>
          <select class="form-select" [(ngModel)]="selectedStatus">
            <option value="">All Status</option>
            <option *ngFor="let status of statusOptions" [value]="status">
              {{ status }}
            </option>
          </select>
        </div>

        <!-- Action Buttons -->
        <div class="col-md-1 d-flex align-items-end">
          <div class="btn-group w-100">
            <button class="btn btn-primary btn-sm" (click)="applyFilters()">
              <i class="fas fa-search"></i>
            </button>
            <button class="btn btn-outline-secondary btn-sm" (click)="clearFilters()">
              <i class="fas fa-times"></i>
            </button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Results Card -->
  <div class="card">
    <div class="card-header d-flex justify-content-between align-items-center">
      <h5 class="mb-0">
        <i class="fas fa-clipboard-list me-2"></i>All Complaints
      </h5>
      <span class="badge bg-primary">{{ totalElements }} Total Results</span>
    </div>
    
    <div class="card-body p-0">
      <!-- Loading State -->
      <div *ngIf="isLoading" class="text-center py-5">
        <div class="spinner-border text-primary" role="status">
          <span class="visually-hidden">Loading...</span>
        </div>
        <p class="mt-3 text-muted">Loading complaints...</p>
      </div>

      <!-- Error State -->
      <div *ngIf="error" class="alert alert-danger m-3">
        <i class="fas fa-exclamation-triangle me-2"></i>{{ error }}
        <button class="btn btn-sm btn-outline-danger ms-2" (click)="loadComplaints()">
          Try Again
        </button>
      </div>

      <!-- Complaints Table -->
      <div class="table-responsive" *ngIf="!isLoading && !error && complaints.length > 0">
        <table class="table table-hover mb-0">
          <thead class="table-dark">
            <tr>
              <th>Complaint Details</th>
              <th>Member</th>
              <th>Category</th>
              <th>Priority</th>
              <th>Status</th>
              <th>Submission Date</th>
              <th>Assigned To</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody>
            <tr *ngFor="let complaint of complaints" class="align-middle">
              <!-- Complaint Details -->
              <td>
                <div class="fw-bold text-primary">{{ complaint.id | slice:0:8 }}</div>
                <div class="text-truncate" style="max-width: 200px;">{{ complaint.title }}</div>
              </td>

              <!-- Member Details -->
              <td>
                <div class="fw-bold">{{ complaint.memberName }}</div>
                <small class="text-muted">
                  <i [class]="getContactPreferenceIcon(complaint.contactPreference)" class="me-1"></i>
                  ID: {{ complaint.memberId }}
                </small>
              </td>

              <!-- Category -->
              <td>
                <span class="badge bg-light text-dark">{{ complaint.category }}</span>
              </td>

              <!-- Priority -->
              <td>
                <span [class]="getPriorityBadgeClass(complaint.priority)">
                  {{ complaint.priority }}
                </span>
              </td>

              <!-- Status -->
              <td>
                <span [class]="getStatusBadgeClass(complaint.status)">
                  {{ complaint.status }}
                </span>
              </td>

              <!-- Submission Date -->
              <td>
                <div>{{ formatDate(complaint.submissionDate) }}</div>
              </td>

              <!-- Assigned To -->
              <td>
                <div *ngIf="complaint.assignedTo; else unassigned">
                  <div class="fw-bold">{{ complaint.assignedTo }}</div>
                </div>
                <ng-template #unassigned>
                  <span class="text-muted">Unassigned</span>
                </ng-template>
              </td>

              <!-- Actions -->
              <td>
                <div class="btn-group" role="group">
                  <!-- View Details -->
                  <button
                    class="btn btn-sm btn-outline-info"
                    (click)="viewComplaintDetails(complaint.id)"
                    title="View Details"
                  >
                    <i class="fas fa-eye"></i>
                  </button>

                  <!-- Update Status -->
                  <button 
                    class="btn btn-sm btn-outline-success" 
                    (click)="openStatusModal(complaint)"
                    title="Update Status"
                  >
                    <i class="fas fa-edit"></i>
                  </button>
                </div>
              </td>
            </tr>
          </tbody>
        </table>
      </div>

      <!-- No Results -->
      <div *ngIf="!isLoading && !error && complaints.length === 0" class="text-center py-5">
        <i class="fas fa-clipboard-list fa-3x text-muted mb-3"></i>
        <h5 class="text-muted">No Complaints Found</h5>
        <p class="text-muted">No complaints match your current filter criteria.</p>
        <button class="btn btn-outline-primary" (click)="clearFilters()">
          Clear All Filters
        </button>
      </div>
    </div>

    <!-- Pagination -->
    <div class="card-footer" *ngIf="totalPages > 1">
      <app-pagination
        [currentPage]="currentPage"
        [totalPages]="totalPages"
        (pageChange)="onPageChange($event)">
      </app-pagination>
    </div>
  </div>
</div>

<!-- Status Update Modal -->
<app-confirmation-dialog
  [isVisible]="showStatusModal"
  [title]="'Update Status'"
  [message]="'Select new status for this complaint:'"
  [confirmText]="'Update'"
  [cancelText]="'Cancel'"
  [isProcessing]="isProcessing"
  (confirmed)="confirmStatusUpdate()"
  (cancelled)="closeStatusModal()">
  
  <div class="mt-3">
    <select class="form-select" [(ngModel)]="selectedStatusUpdate" required>
      <option value="">Select Status</option>
      <option *ngFor="let status of statusOptions" [value]="status">
        {{ status }}
      </option>
    </select>
  </div>
</app-confirmation-dialog>
