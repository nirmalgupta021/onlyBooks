<div class="edit-book-container">
  <!-- Page Header -->
  <div class="d-flex justify-content-between align-items-center mb-4">
    <div>
      <h2 class="h3 mb-0 text-gradient">Edit Book</h2>
      <p class="text-muted mb-0">Update book information</p>
    </div>
    <a routerLink="/admin/books" class="btn btn-outline-secondary">
      <i class="fas fa-arrow-left me-2"></i>Back to Books
    </a>
  </div>

  <!-- Loading State -->
  <div *ngIf="isLoading" class="text-center py-5">
    <div class="spinner-border text-primary" role="status">
      <span class="visually-hidden">Loading...</span>
    </div>
    <p class="mt-3 text-muted">Loading book details...</p>
  </div>

  <!-- Edit Book Form -->
  <div class="card" *ngIf="!isLoading && bookForm">
    <div class="card-header">
      <h5 class="card-title mb-0">
        <i class="fas fa-edit me-2"></i>Update Book Information
      </h5>
    </div>
    <div class="card-body">
      <form [formGroup]="bookForm" (ngSubmit)="onSubmit()" novalidate>
        <div class="row">
          <!-- Book Cover Image -->
          <div class="col-md-4 mb-4">
            <div class="book-cover-section">
              <label class="form-label">Book Cover Image</label>
              <div class="image-upload-area" (click)="fileInput.click()">
                <div *ngIf="!imagePreview && !currentBook?.imageUrl" class="upload-placeholder">
                  <i class="fas fa-camera fa-2x text-muted mb-2"></i>
                  <p class="text-muted">Click to upload cover image</p>
                  <small class="text-muted">JPG, PNG, GIF (Max: 2MB)</small>
                </div>
                <div *ngIf="imagePreview || currentBook?.imageUrl" class="image-preview">
                  <img [src]="imagePreview || currentBook?.imageUrl" alt="Book cover" class="img-fluid">
                  <div class="image-overlay">
                    <i class="fas fa-edit text-white"></i>
                  </div>
                </div>
              </div>
              <input
                #fileInput
                type="file"
                accept="image/*"
                (change)="onImageSelected($event)"
                style="display: none;"
              />
              <div class="invalid-feedback" *ngIf="imageError">
                {{ imageError }}
              </div>
            </div>
          </div>

          <!-- Book Details -->
          <div class="col-md-8">
            <div class="row">
              <!-- Book ID (Non-editable) -->
              <div class="col-12 mb-3">
                <label class="form-label">Book ID</label>
                <input
                  type="text"
                  class="form-control"
                  [value]="currentBook?.id"
                  readonly
                  disabled
                />
              </div>

              <!-- Book Title -->
              <div class="col-md-6 mb-3">
                <label for="title" class="form-label">Book Title <span class="text-danger">*</span></label>
                <input
                  type="text"
                  class="form-control"
                  id="title"
                  formControlName="title"
                  placeholder="Enter book title"
                  [class.is-invalid]="title?.invalid && (title?.dirty || title?.touched)"
                />
                <div class="invalid-feedback" *ngIf="title?.invalid && (title?.dirty || title?.touched)">
                  <div *ngIf="title?.errors?.['required']">Book title is required</div>
                  <div *ngIf="title?.errors?.['minlength']">Title must be at least 2 characters long</div>
                </div>
              </div>

              <!-- Author -->
              <div class="col-md-6 mb-3">
                <label for="author" class="form-label">Author <span class="text-danger">*</span></label>
                <input
                  type="text"
                  class="form-control"
                  id="author"
                  formControlName="author"
                  placeholder="Enter author name"
                  [class.is-invalid]="author?.invalid && (author?.dirty || author?.touched)"
                />
                <div class="invalid-feedback" *ngIf="author?.invalid && (author?.dirty || author?.touched)">
                  <div *ngIf="author?.errors?.['required']">Author name is required</div>
                  <div *ngIf="author?.errors?.['minlength']">Author name must be at least 2 characters long</div>
                </div>
              </div>

              <!-- Category -->
              <div class="col-md-6 mb-3">
                <label for="category" class="form-label">Category <span class="text-danger">*</span></label>
                <select
                  class="form-select"
                  id="category"
                  formControlName="category"
                  [class.is-invalid]="category?.invalid && (category?.dirty || category?.touched)"
                >
                  <option value="">Select a category</option>
                  <option *ngFor="let cat of bookCategories" [value]="cat">{{ cat }}</option>
                </select>
                <div class="invalid-feedback" *ngIf="category?.invalid && (category?.dirty || category?.touched)">
                  <div *ngIf="category?.errors?.['required']">Category is required</div>
                </div>
              </div>

              <!-- Total Copies -->
              <div class="col-md-6 mb-3">
                <label for="totalCopies" class="form-label">Total Copies <span class="text-danger">*</span></label>
                <input
                  type="number"
                  class="form-control"
                  id="totalCopies"
                  formControlName="totalCopies"
                  placeholder="Enter total copies"
                  min="1"
                  [class.is-invalid]="totalCopies?.invalid && (totalCopies?.dirty || totalCopies?.touched)"
                />
                <div class="invalid-feedback" *ngIf="totalCopies?.invalid && (totalCopies?.dirty || totalCopies?.touched)">
                  <div *ngIf="totalCopies?.errors?.['required']">Total copies is required</div>
                  <div *ngIf="totalCopies?.errors?.['min']">Must be at least 1 copy</div>
                </div>
              </div>

              <!-- Description -->
              <div class="col-12 mb-3">
                <label for="description" class="form-label">Description <span class="text-danger">*</span></label>
                <textarea
                  class="form-control"
                  id="description"
                  formControlName="description"
                  rows="4"
                  placeholder="Enter book description"
                  [class.is-invalid]="description?.invalid && (description?.dirty || description?.touched)"
                ></textarea>
                <div class="invalid-feedback" *ngIf="description?.invalid && (description?.dirty || description?.touched)">
                  <div *ngIf="description?.errors?.['required']">Description is required</div>
                  <div *ngIf="description?.errors?.['minlength']">Description must be at least 10 characters long</div>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Form Actions -->
        <div class="d-flex justify-content-end mt-4">
          <button
            type="button"
            class="btn btn-outline-secondary me-3"
            (click)="resetForm()"
            [disabled]="isSubmitting"
          >
            <i class="fas fa-undo me-2"></i>Reset Changes
          </button>
          <button
            type="submit"
            class="btn btn-primary"
            [disabled]="bookForm.invalid || isSubmitting || !bookForm.dirty"
          >
            <span *ngIf="isSubmitting" class="spinner-border spinner-border-sm me-2"></span>
            <i class="fas fa-save me-2" *ngIf="!isSubmitting"></i>
            {{ isSubmitting ? 'Updating Book...' : 'Update Book' }}
          </button>
        </div>
      </form>
    </div>
  </div>
</div>

<!-- Confirmation Modal -->
<app-confirmation-dialog
  [isVisible]="showUpdateConfirmation"
  [title]="'Update Book'"
  [message]="'Are you sure you want to update this book with the new information?'"
  [confirmText]="'Update'"
  [isProcessing]="isSubmitting"
  (confirmed)="confirmUpdate()"
  (cancelled)="cancelUpdate()">
</app-confirmation-dialog>
